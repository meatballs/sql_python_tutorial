<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://www.owencampbell.me.uk/images/favicon/favicon.ico" rel="icon">

  <title>SQL for Python Programmers</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
  <link href="https://www.owencampbell.me.uk/theme/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/sql_python_tutorial/static/styles.css">

  
    <link rel="stylesheet" href="/sql_python_tutorial/static/notebook.css">
  
</head>

<body>
  <div class="fixed-top">
    
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">

  <a class="navbar-brand" href="#">SQL for Python Programmers</a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarContent">
    <div class="navbar-nav">
        <a class="nav-item nav-link" href="/sql_python_tutorial/"><i class="fa fa-home fa-fw" aria-hidden="true" title="home"></i>&nbsp;Home</a>
        <a class="nav-item nav-link mr-auto" href="/sql_python_tutorial/chapters/"><i class="fa fa-book fa-fw" aria-hidden="true" title="contents"></i>&nbsp;Contents</a>
        <a class="nav-item nav-link" href="/sql_python_tutorial/pages/intro.html"><i class="fa fa-info-circle fa-fw" aria-hidden="true" title="introduction"></i>&nbsp;Introduction</a>
        <a class="nav-item nav-link" href="/sql_python_tutorial/pages/howto.html"><i class="fa fa-gears fa-fw" aria-hidden="true" title="how to"></i>&nbsp;How To</span></a>
        <a class="nav-item nav-link" href="/sql_python_tutorial/pages/primer.html"><i class="fa fa-database fa-fw" aria-hidden="true" title="primer"></i>&nbsp;Primer</a>
    </div>
    <div class="navbar-nav ml-auto">
      <a class="btn btn-link btn-lg" href="https://www.linkedin.com/in/owencampbell" title="linkedin"><i class="fa fa-linkedin" aria-hidden="true"></i></a>
      <a class="btn btn-link btn-lg" href="http://github.com/meatballs" title="github"><i class="fa fa-github" aria-hidden="true"></i></a>
    </div>
  </div>
</nav>
    <nav class="navbar bg-white">
    
    <div class="navbar-nav">
      <a class="btn btn-outline-primary btn-sm" href="../04/"><i class="fa fa-backward fa-fw" aria-hidden="true"></i>&nbsp;Previous</a>
    </div>
    
    
    <div class="navbar-nav ml-auto">
      <a class="btn btn-outline-primary btn-sm" href="../06/">Next&nbsp;<i class="fa fa-forward fa-fw" aria-hidden="true"></i></a>
    </div>
    
</nav>
  
  </div>

  <main role="main" class="container">
    

    <div class="row">
      <div class="col-sm-12">
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Change-The-Data">Change The Data<a class="anchor-link" href="#Change-The-Data">&#182;</a></h1><p>To change records in a table, we use an 'UPDATE' statement.</p>
<p>First, let's connect to our database and remind ourselves what records we have created so far:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///flight.db&#39;</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s1">&#39;readings&#39;</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[1]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>flight</th>
      <th>ts</th>
      <th>temp</th>
      <th>pressure</th>
      <th>humidity</th>
      <th>accel_x</th>
      <th>accel_y</th>
      <th>accel_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>hab1</td>
      <td>2015-01-01 09:00:00</td>
      <td>25.5</td>
      <td>1020</td>
      <td>40</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>hab1</td>
      <td>2015-01-01 09:01:00</td>
      <td>25.5</td>
      <td>1019</td>
      <td>40</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>hab1</td>
      <td>2015-01-01 09:02:00</td>
      <td>25.5</td>
      <td>1019</td>
      <td>41</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In an UPDATE statement, we define the table containing the records we want to change, the columns we want to change and the new values for those columns:</p>
<div class="highlight"><pre><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">readings</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">pressure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1021</span><span class="p">,</span><span class="w"> </span><span class="n">humidity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
</pre></div>
<p>If we were to run this statement, it would update all the records in our table.</p>
<p>Let's imagine we only wanted to change one of them. To do that, we need to include a 'WHERE' clause:</p>
<div class="highlight"><pre><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">readings</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">pressure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1021</span><span class="p">,</span><span class="w"> </span><span class="n">humidity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">flight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;hab1&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">humidity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">41</span><span class="w"></span>
</pre></div>
<p>Let's execute this statement and use pandas to show us the updated result:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    UPDATE readings</span>
<span class="s2">    SET pressure = 1021, humidity = 42</span>
<span class="s2">    WHERE flight = &#39;hab1&#39; and humidity = 41</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s1">&#39;readings&#39;</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[2]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>flight</th>
      <th>ts</th>
      <th>temp</th>
      <th>pressure</th>
      <th>humidity</th>
      <th>accel_x</th>
      <th>accel_y</th>
      <th>accel_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>hab1</td>
      <td>2015-01-01 09:00:00</td>
      <td>25.5</td>
      <td>1020</td>
      <td>40</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>hab1</td>
      <td>2015-01-01 09:01:00</td>
      <td>25.5</td>
      <td>1019</td>
      <td>40</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>hab1</td>
      <td>2015-01-01 09:02:00</td>
      <td>25.5</td>
      <td>1021</td>
      <td>42</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that the third record now has the updated pressure and humidity values and the first two records are unchanged.</p>
<p>We've seen previously that the check constraints on our table ensure that any record we try to insert must be valid. What happens if we attempt to update an existing record with invalid values?</p>
<p>Let's try changing one of our humidity values to a negative number:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    UPDATE readings</span>
<span class="s2">    SET humidity = -40</span>
<span class="s2">    WHERE flight = &#39;hab1&#39; and humidity = 41</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>(sqlite3.IntegrityError) CHECK constraint failed: hum_ck [SQL: &#34;\n    UPDATE readings\n    SET humidity = -40\n    WHERE flight = &#39;hab1&#39; and humidity = 41\n&#34;] (Background on this error at: http://sqlalche.me/e/gkpj)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once again, SQLAlchemy raises an IntegrityError, our update fails and the check constraint has stopped us creating invalid records.</p>

</div>
</div>
</div>
 

</div>
    </div>

  
  </main>

  
  <footer class="footer d-none d-md-block">
      <div class="container">
    <span class="text-muted">
      <p class="small">
        This tutorial was inspired by a talk given by <a href="https://twitter.com/waveform80">Dave Jones</a> at <a href="https://twitter.com/pythonnw">Python North West</a>.
        The flights database, and much of the SQL code, is taken, with grateful thanks,
        from the <a href="https://waveform.org.uk/presentations/sql">slides</a> and
        <a href="https://github.com/waveform80/presentations">source code</a> for that talk.
      <br/>
        Many thanks also to <a href="https://vknight.org/">Dr. Vincent Knight</a> of <a href="http://www.cardiff.ac.uk">Cardiff University</a> for the use of his
        <a href="https://vknight.org/gt/">Game Theory Course Notes</a> and their <a href="https://github.com/drvinceknight/gt">source code</a>.
      </p>
    </span>
  </div>
  </footer>
  

</body>

</html>